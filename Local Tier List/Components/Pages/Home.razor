@page "/"
@using System.Text.Json
@using Microsoft.Extensions.Logging
@using Microsoft.Maui.ApplicationModel
@inject ILogger<Home> Logger
@inject IJSRuntime JS
@inject ISnackbar Snackbar
<link href="css/charactercolor.css" rel="stylesheet" />

<div class="m-md-1 p-md-1 m-lg-4 p-lg-4 overflow-hidden">
	<h1 class="text-light">Local Tier List Maker</h1>
	<div class="d-flex col-12 col-md-6">
		<div class="row col-sm-4 col-md-3 col-lg-2 mx-2 my-1 d-flex flex-fill flex-wrap">
			<div class="row p-0 col-12 d-flex flex-fill">
				<div class="d-flex col-12 p-0 flex-nowrap flex-fill flex-row">
					<h5 class="clickable flex-fill p-1 m-0 text-center rounded btn bg-primary align-content-center" @onclick="ImportOpen"> Import Tierlists </h5>
				</div>
			</div>
		</div>
		<div class="row col-sm-4 col-md-3 col-lg-2 mx-2 my-1 d-flex flex-fill flex-wrap">
			<div class="row p-0 col-12 d-flex flex-fill">
				<div class="d-flex col-12 p-0 flex-nowrap flex-fill flex-row">
					<h5 class="clickable flex-fill p-2 m-0 text-center rounded btn bg-primary align-content-center" @onclick="ExportAll"> Export All Tierlists </h5>
				</div>
			</div>
		</div>
	</div>
	<div class="row col-12 d-flex flex-column text-light m-2">
		<h5> Tier Lists: </h5>
		@if (lists!.Count <= 0)
		{
			<div class="col-sm-12 col-lg-4 mx-2 flex-column justify-content-center d-flex flex-fill">
				<h5> There are no saved TierLists, create one with the "New TierList" button!. </h5>
			</div>
		}
		<div class="row mx-1 flex-row justify-content-center col-12 flex-fill flex-wrap d-flex">
			@for (int local = 0; local < lists.Count; local++)
			{
				int i = local;
				<div class="row col-sm-4 col-md-3 col-lg-2 mx-0 my-1 d-flex flex-fill flex-wrap">
					<div class="row p-0 col-12 d-flex flex-fill">
						<div class="d-flex col-12 p-0 flex-nowrap flex-fill flex-row">
							<a class="bg-highlight col-10 text-light btn text-center justify-content-center p-2 rounded clickable align-content-center" @onclick="() => Select(lists[i])">@lists[i].name</a>
							<button class="text-light col-2 p-2 ms-1 btn bg-danger clickable rounded flex-nowrap align-content-center" @onclick="() => YouSure(lists[i])">✖</button>
						</div>
					</div>
				</div>
			}
			<div class="row col-sm-4 col-md-3 col-lg-2 mx-0 my-1 d-flex flex-fill flex-wrap">
				<div class="row p-0 col-12 d-flex flex-fill">
					<div class="d-flex col-12 p-0 flex-nowrap flex-fill flex-row">
						<h5 class="clickable flex-fill p-0 m-0 text-center rounded btn template align-content-center" @onclick="NewTierList"> New Tierlist </h5>
					</div>
				</div>
			</div>
		</div>
	</div>
	@if (selected != null)
	{
		<h5 class="ms-4">Display Settings:</h5>
		<div class="d-flex flex-row gap-3 p-2 darken-25 rounded ms-2">
			<div class="form-check form-switch">
				<input class="form-check-input" type="checkbox" id="showcaseform"
					   @onchange="() => Toggle(ref showcase)">
				<label class="form-check-label" for="showcaseform">
					Showcase Mode
				</label>
			</div>

			<div class="form-check form-switch">
				<input class="form-check-input" type="checkbox" id="minimalform"
					   @onchange="() => Toggle(ref minimal)">
				<label class="form-check-label" for="minimalform">
					Minimal Mode
				</label>
			</div>

			<div class="form-check form-switch">
				<input class="form-check-input" type="checkbox" id="textform"
					   @onchange="() => Toggle(ref NoImg)">
				<label class="form-check-label" for="textform">
					Text Only
				</label>
			</div>
		</div>

		<TierListComp selected="selected" tl="TierService.tl" showcase="showcase" minimal="minimal" NoImg="NoImg"
		OnExport="@(() => SnackAlert("Exported Tierlist copied to clipboard"))" OnError="@(new Action<string>(e => SnackError(e)))"/>
	}

	<!-- -- -- -- -- -- -- MODALS -- -- -- -- -- -- -- -->
	@if (yousure)
	{
		<div class="maiedal d-flex flex-column text-center justify-content-center">
			<div class="p-2 darken-95 d-flex rounded text-center flex-column justify-content-center mx-auto text-light col-6">
				<p> Are you sure you want to permanently remove this tierlist? All tiers and items registered within will be deleted! </p>
				<div class="d-flex flex-row flex-wrap mx-auto">
					<button class="mx-2 btn text-light" @onclick="YouSure">No</button>
					<button class="mx-2 btn text-danger" @onclick="Delete">Yes, remove it and all items within</button>
				</div>
			</div>
		</div>

	}
	@if (ImportMenu)
	{
		<div class="maiedal d-flex flex-column text-center justify-content-center">
			<div class="p-2 darken-95 d-flex rounded text-center flex-column justify-content-center mx-auto text-light col-12 col-md-6">
				<p> Paste below the JSON string of the Tierlist(s) you want to import! </p>
				<textarea class="font-monospace bg-dark text-light col-12 mb-2" style="height:200px;" @bind="importString"></textarea>
				<div>
					<p class="text-danger">@importErr</p>
				</div>
				<div class="form-check form-switch text-start mx-3 mb-3">
					<input class="form-check-input" type="checkbox" id="ireplace"
						   @onchange="() => Toggle(ref ImportReplace)">
					<label class="form-check-label" for="ireplace">
						Replace current Tierlists
					</label>
				</div>
				<div class="d-flex flex-row flex-wrap mx-auto">
					<button class="mx-2 border-1 border-white text-light rounded btn p-2" @onclick="() => ImportMenu = false">Cancel</button>
					<button class="mx-2 bg-highlight rounded btn p-2 text-light" @onclick="ImportTierLists">Import</button>
				</div>
			</div>
		</div>

	}
</div>


@code
{
	List<TierList>? lists;
	TierList? selected;

	TierList? selected2;

	string importString = "";
	string importErr = "";

	bool showcase, minimal, NoImg, yousure, ImportMenu, ImportReplace;

	protected override async Task OnInitializedAsync()
	{
		lists = TierService.TierLists;
		if (lists == null)
			lists = new List<TierList>();		

	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		StateHasChanged();
	}

	void Select(TierList l)
	{
		if (l == selected)
		{
			selected = null;
		}
		else
		{
			selected = l;
		}
	}

	void NewTierList()
	{
		TierService.TierLists.Add(new TierList($"Tierlist {TierService.TierLists.Count + 1}", true));
		Select(TierService.TierLists.Last());
	}

	void YouSure(TierList l)
	{
		if (yousure)
		{
			yousure = false;
			selected2 = null;
		}
		else
		{
			yousure = true;
			selected2 = l;
		}
	}
	void YouSure()
	{
		if (yousure)
		{
			yousure = false;
			selected2 = null;
		}
	}

	void ImportOpen()
	{
		ImportMenu = true;
	}

	void SnackAlert(string message)
	{
		Snackbar.Add(message, Severity.Info);
	}
	void SnackError(string message)
	{
		Snackbar.Add(message, Severity.Error);
	}

	async Task ExportAll()
	{
		var json = TierService.tl?.ExportJson() ?? string.Empty;
		if (string.IsNullOrEmpty(json))
		{
			Logger.LogWarning("ExportAll: no JSON produced from TierService.tl.ExportJson()");
            SnackError("No TierLists to export.");
			return;
		}

		try
		{
			#if ANDROID || WINDOWS || IOS || MACCATALYST
			// Use native MAUI clipboard when running as a MAUI app (Android, Windows, iOS, MacCatalyst).
			await Clipboard.SetTextAsync(json);
			#else
	// Fallback for browser/web: use navigator.clipboard via JS interop.
	await JS.InvokeVoidAsync("navigator.clipboard.writeText", json);
			#endif
			Logger.LogInformation("Exported JSON copied to clipboard.");
			SnackAlert("TierLists Data copied to clipboard.");
		}
		catch (Exception ex)
		{
			Logger.LogError(ex, "Failed to copy exported JSON to clipboard using primary method.");
			// Try the other approach as a best-effort fallback.
			try
			{
				await JS.InvokeVoidAsync("navigator.clipboard.writeText", json);
				Logger.LogInformation("Fallback: exported JSON copied to clipboard via JS.");
                SnackAlert("TierLists Data copied to clipboard.");
			}
			catch (Exception jsEx)
			{
				Logger.LogError(jsEx, "Fallback copy to clipboard via JS also failed.");
                SnackError("Failed to copy TierLists Data to clipboard.");
			}
		}
	}

	void ImportTierLists()
	{
		if (!String.IsNullOrEmpty(importString))
		{
			try
			{
				var imported = TierService.Import(importString);
				if (imported != null && imported.Count > 0)
				{
					if (ImportReplace)
					{
						TierService.TierLists.Clear();
                    }
					foreach (var tl in imported)
					{
						TierService.TierLists.Add(tl);
					}
					TierService.SaveAll();
					lists = TierService.TierLists;
					importErr = "";
					ImportMenu = false;
				}
				else
				{
					importErr = "Couldn't identify any elements in the json...";
				}
			}
			catch (Exception e)
			{
				importErr = e.Message;
			}
		}
	}

	void Toggle(ref bool t)
	{
		t = !t;
	}

	void Delete()
	{
		if (selected == selected2)
		{
			selected = null;
		}
		if (selected2 == null) return;
		TierService.TierLists.Remove(selected2);
		TierService.SaveAll();
		yousure = false;
	}
}